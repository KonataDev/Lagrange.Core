using System.Text.Json.Nodes;
using Lagrange.Core;
using Lagrange.Core.Internal.Event.Message;
using Lagrange.Core.Message.Entity;
using Lagrange.OneBot.Core.Entity.Action;
using Lagrange.OneBot.Message.Entity;

namespace Lagrange.OneBot.Core.Operation.Ability;

[Operation("upload_image")]
public class UploadImageOperation : IOperation
{
		public const string ImageUploadFailUrl = "data:image/png;base64,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";

		public async Task<OneBotResult> HandleOperation(BotContext context, JsonNode? payload)
		{
				if (payload?["file"]?.ToString() is { } file && CommonResolver.ResolveStream(file) is { } stream)
				{
						var entity = new ImageEntity(stream);
						var success = await context.ContextCollection.Highway.ManualUploadEntity(entity);
						if (!success)
								return new OneBotResult(ImageUploadFailUrl, 0, "image upload fail");
						var msgInfo = entity.MsgInfo;
						if (msgInfo is null) throw new Exception("image-msg is empty");

						var downloadEvent = ImageDownloadEvent.Create(context.ContextCollection.Keystore.Uid ?? "", msgInfo);
						var result = await context.ContextCollection.Business.SendEvent(downloadEvent);
						var ret = (ImageDownloadEvent)result[0];

						return new OneBotResult(ret.ImageUrl, 0, "ok");
				}

				throw new Exception();
		}
}